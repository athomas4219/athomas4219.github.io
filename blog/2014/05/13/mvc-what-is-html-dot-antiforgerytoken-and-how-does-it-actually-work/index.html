
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>MVC: What Is Html.AntiForgeryToken and How Does It Actually Work? - Andrew Thomas' Blog</title>
  <meta name="author" content="Andrew Thomas">

  
  <meta name="description" content="The anti-forgery token found in MVC is a way to prevent cross site request forgery (CSRF) attacks. Without going into too much detail, a CSRF attack &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.at-dot.net/blog/2014/05/13/mvc-what-is-html-dot-antiforgerytoken-and-how-does-it-actually-work">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Andrew Thomas' Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Andrew Thomas' Blog</a></h1>
  
    <h2>Like we need another blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.at-dot.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
	<li><a href="/about">About</a></li>
	<li><a href="https://github.com/athomas4219/feedback/issues/new">Contact</a></li>  
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">MVC: What Is Html.AntiForgeryToken and How Does It Actually Work?</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-13T10:28:34-04:00" pubdate data-updated="true">May 13<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>The anti-forgery token found in MVC is a way to prevent <a href="http://en.wikipedia.org/wiki/Csrf">cross site request forgery</a> (CSRF) attacks. Without going into too much detail, a CSRF attack occurs when a user visits an untrusted site and enters some information that is then posted back to a site to which the user has already authenticated. Protection against this exploit has shipped with MVC since at least version 4 and is very easy to implement.</p>

<h2>How to Implement the Anti-forgery Token</h2>

<p>Protecting your web site is as easy as adding some code to your view and decorating the view&rsquo;s controller action with an attribute. <strong>Note:</strong> if either one of these steps is not done, your web site won&rsquo;t be protected and may or may not cause an exception at run time.</p>

<p>First, you add a call to <code>Html.AntiForgeryToken()</code> inside any <code>form</code> tag that you want to protect.</p>

<p><strong>Note:</strong> if you, like me, sometimes get so focused on not forgetting to add the anti-forgery token that it is the first code that you add to the page, you may find that you add it outside of the <code>using</code> statement, causing an exception at run time:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>The required anti-forgery form field "__RequestVerificationToken" is not present.</span></code></pre></td></tr></table></div></figure>


<p>If this occurs, simply move your anti-forgery token inside the <code>using</code> statement, as seen in the sample below. It belongs inside the <code>form</code> tag on the page.</p>

<p>The following is an example of a Razor view for a form that contains a name and email field. The only additional magic here is to add the line containing <code>@Html.AntiForgeryToken()</code>.</p>

<figure class='code'><figcaption><span>Views\Home\Sample.cshtml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">@model</span> <span class="n">AntiForgerySample</span><span class="p">.</span><span class="n">Models</span><span class="p">.</span><span class="n">SampleViewModel</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="p">{</span>
</span><span class='line'>    <span class="n">ViewBag</span><span class="p">.</span><span class="n">Title</span> <span class="p">=</span> <span class="s">&quot;Sample&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">h2</span><span class="p">&gt;</span><span class="n">AntiForgeryToken</span> <span class="n">Sample</span><span class="p">&lt;/</span><span class="n">h2</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">@using</span> <span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">BeginForm</span><span class="p">(</span><span class="s">&quot;Sample&quot;</span><span class="p">,</span> <span class="s">&quot;Home&quot;</span><span class="p">,</span> <span class="n">FormMethod</span><span class="p">.</span><span class="n">Post</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">role</span> <span class="p">=</span> <span class="s">&quot;form&quot;</span> <span class="p">}))</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">@Html</span><span class="p">.</span><span class="n">AntiForgeryToken</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Html</span><span class="p">.</span><span class="n">ValidationSummary</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
</span><span class='line'>        <span class="n">@Html</span><span class="p">.</span><span class="n">LabelFor</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
</span><span class='line'>        <span class="n">@Html</span><span class="p">.</span><span class="n">EditorFor</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
</span><span class='line'>        <span class="n">@Html</span><span class="p">.</span><span class="n">LabelFor</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Email</span><span class="p">)</span>
</span><span class='line'>        <span class="n">@Html</span><span class="p">.</span><span class="n">EditorFor</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Email</span><span class="p">)</span>
</span><span class='line'>    <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span><span class="n">button</span> <span class="n">type</span><span class="p">=</span><span class="s">&quot;submit&quot;</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;btn btn-default&quot;</span><span class="p">&gt;</span><span class="n">Save</span><span class="p">&lt;/</span><span class="n">button</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, you decorate your controller action with the <code>ValidateAntiForgeryToken</code> attribute. The following is the controller action to support the above view.</p>

<figure class='code'><figcaption><span>Controllers\HomeController.cs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[HttpPost]</span>
</span><span class='line'><span class="na">[ValidateAntiForgeryToken]</span>
</span><span class='line'><span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Sample</span><span class="p">(</span><span class="n">FormCollection</span> <span class="n">formCollection</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Models</span><span class="p">.</span><span class="n">SampleViewModel</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">TryUpdateModel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">formCollection</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Do some things with the model, then redirect to the home page</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">RedirectToAction</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="s">&quot;Home&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>So how does it actually work?</h2>

<p>Under the covers, the call to <code>Html.AntiForgeryToken()</code> does two things. First, it causes a hidden input to be created in the form, like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;__RequestVerificationToken&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;MRRR4ga6eu8EiCeHKdJAiZgF1EO4OC52U3L6UUe_nqIfe7I7jONPmsJ2Vc_chDi7gA7drUYy4hyehi_UDkso2wrbmLgaKXGypM0rAfHec7g1&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Second, it causes a cookie also called <code>__RequestVerificationToken</code> to be created with the same value.</p>

<p>When the page gets posted to the server, the <code>ValidateAntiForgeryToken</code> attribute causes the MVC framework to marry the hidden form parameter with the cookie value. If they are not the same, or either one is missing, the server knows that the post did not come from our own server and that we shouldn&rsquo;t trust the input, causing an exception to be thrown.</p>

<p>The magic that occurs here is that the browser will only send the cookie if it&rsquo;s posting to the domain that created the cookie. Thus, if a user inputs data into an untrusted site, which then posts back to our site, the anti-forgery token on the page will not match the one previously created and stored in the cookie. When MVC smells something fishy, it throws an exception, protecting our user from an attack.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Andrew Thomas</span></span>

      








  


<time datetime="2014-05-13T10:28:34-04:00" pubdate data-updated="true">May 13<span>th</span>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.at-dot.net/blog/2014/05/13/mvc-what-is-html-dot-antiforgerytoken-and-how-does-it-actually-work/" data-via="athomas4219" data-counturl="http://blog.at-dot.net/blog/2014/05/13/mvc-what-is-html-dot-antiforgerytoken-and-how-does-it-actually-work/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/05/08/preparing-your-webapi-site-to-produce-better-documentation/" title="Previous Post: Preparing Your WebAPI Site To Produce Better Documentation">&laquo; Preparing Your WebAPI Site To Produce Better Documentation</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/13/mvc-what-is-html-dot-antiforgerytoken-and-how-does-it-actually-work/">MVC: What Is Html.AntiForgeryToken and How Does It Actually Work?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/08/preparing-your-webapi-site-to-produce-better-documentation/">Preparing Your WebAPI Site to Produce Better Documentation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/16/resizing-the-screen-resolution-in-ubuntu-when-you-cant-see-the-apply-button/">Resizing the Screen Resolution in Ubuntu When You Can't See the Apply Button</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/15/outlook-has-left-the-building/">Outlook Has Left the Building</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/29/entity-framework-6-specifying-a-connectionstring-in-code/">Entity Framework 6: Specifying a ConnectionString in Code</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/athomas4219">@athomas4219</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'athomas4219',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Andrew Thomas -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'andrewthomasblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.at-dot.net/blog/2014/05/13/mvc-what-is-html-dot-antiforgerytoken-and-how-does-it-actually-work/';
        var disqus_url = 'http://blog.at-dot.net/blog/2014/05/13/mvc-what-is-html-dot-antiforgerytoken-and-how-does-it-actually-work/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
